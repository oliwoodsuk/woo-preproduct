#!/bin/bash

# WooPreProduct Zip Script
# 
# Creates a clean zip archive of the project excluding files based on .distignore patterns.
# This script reads .distignore file and converts patterns to zip exclusions.

# Check if .distignore file exists
if [ ! -f ".distignore" ]; then
    echo "Error: .distignore file not found!"
    exit 1
fi

echo "Creating preproduct.zip using .distignore patterns..."
echo "Reading exclusion patterns from .distignore..."

# Create temporary file for zip exclusions
TEMP_EXCLUDE_FILE=$(mktemp)

# Read .distignore file and write patterns to temp file
while IFS= read -r line; do
    # Skip empty lines and comments
    if [[ -n "$line" && ! "$line" =~ ^#.*$ ]]; then
        # Skip any pattern that would exclude /admin or its contents
        if [[ "$line" =~ ^/?admin(/.*)?$ ]] || [[ "$line" =~ ^admin(/.*)?$ ]]; then
            # Skip this line to always include /admin
            continue
        fi
        # Convert .distignore patterns to zip exclusion format
        # Remove trailing slashes for directories
        pattern="${line%/}"
        
        # For directories (with trailing slash), exclude both the directory and its contents
        if [[ "$line" =~ .*/$  ]]; then
            echo "$pattern" >> "$TEMP_EXCLUDE_FILE"
            echo "${pattern}/*" >> "$TEMP_EXCLUDE_FILE"
        else
            # For files or patterns without trailing slash, add as-is
            echo "$pattern" >> "$TEMP_EXCLUDE_FILE"
        fi
    fi
done < .distignore

# Always exclude some OS-specific files regardless of .distignore
echo "*.DS_Store" >> "$TEMP_EXCLUDE_FILE"
echo "__MACOSX" >> "$TEMP_EXCLUDE_FILE"
echo ".DS_Store" >> "$TEMP_EXCLUDE_FILE"
echo "build-deployment.php" >> "$TEMP_EXCLUDE_FILE"

# Create the zip archive using the exclusion file
echo "Building archive with exclusions..."
zip -r ../preproduct.zip . -x@"$TEMP_EXCLUDE_FILE"

# Clean up temp file
rm -f "$TEMP_EXCLUDE_FILE"

if [ $? -eq 0 ]; then
    echo "✓ Zip archive created successfully in ../preproduct.zip"
    echo "✓ Files excluded based on .distignore patterns"
    
    # Show some stats
    echo ""
    echo "Archive contents:"
    unzip -l ../preproduct.zip | tail -2
else
    echo "✗ Error creating zip archive"
    exit 1
fi 